var dug=function(opts){function render(tpl,data,delims){function dotData(d,dotKey){var invert="";var filters=dotKey.split("|"),name=filters.shift();if(name.indexOf("!")>-1){name=name.replace(/!/ig,"");invert="!"}try{val=eval(invert+"d['"+name.split(".").join("']['")+"']");if(filters){for(var i=0,max=filters.length;i<max;++i){var chunks=filters[i].split(":"),filter=chunks.shift(),params=chunks;f=eval(filter);if(typeof f=="function"){newval=f.apply(d,[val].concat(params))}val=newval}}}catch(e){val=""}return val}tpl=unescape(tpl);var delims=delims||["{{","}}"];var scopeMatch=new RegExp(delims[0]+"[^"+delims[1]+"]*"+delims[1],"igm");var matches=tpl.match(scopeMatch);if(!matches)return tpl;matches.forEach(function(e){tagMatch=new RegExp(delims[0]+"|"+delims[1],"ig"),scopeName=e.replace(tagMatch,"");if(scopeName[0]=="#"){name=scopeName.slice(1,scopeName.length);startFrag=tpl.indexOf(e);endFrag=tpl.indexOf(e.replace("#","/"))+e.length;frag=tpl.substring(startFrag+e.length,endFrag-e.length);dataFrag=dotData(data,name);rendered="";if(dataFrag){if(dataFrag.constructor==Array){for(var t=0,n=dataFrag.length;t<n;++t){rendered+=render(frag,dataFrag[t])}}else{rendered=render(frag,dataFrag,delims)}startFrag=tpl.indexOf(e);endFrag=tpl.indexOf(e.replace("#","/"))+e.length;tpl=tpl.slice(0,startFrag)+rendered+tpl.slice(endFrag,tpl.length)}}else{val=dotData(data,scopeName)||"";tpl=tpl.replace(e,val)}});return tpl}if(this.constructor!=dug){dug.instance=(new dug(opts)).show();return dug.instance}var options={target:null,endpoint:"",templateDelimiters:["{{","}}"],callbackParam:"callback",cacheExpire:1e3*60*2,beforeRender:function(){},afterRender:function(){},success:function(){},error:function(){},template:"You need a template, silly :P"},getTemplate=function(e){var e=e||options.template,t;if(e.match(/^(#|\.)\w/)){if("querySelectorAll"in document){t=document.querySelectorAll(e);if(t.length>0){t=t[0]}}else{t=document.getElementById(e.replace(/^#/,""))}if(t&&"tagName"in t){e=t.innerHTML}}return e},ext=function(e,t){for(var n in t){if(n in e){if(e[n]&&e[n].constructor==Object){ext(e[n],t[n])}else{e[n]=t[n]}}}},ago=function(e){var t=new Date(e||""),n=((new Date).getTime()-t.getTime())/1e3,r=Math.floor(n/86400);if(isNaN(r)||r<0)return;return r==0&&(n<60&&"just now"||n<120&&"1 minute ago"||n<3600&&Math.floor(n/60)+" minutes ago"||n<7200&&"1 hour ago"||n<86400&&Math.floor(n/3600)+" hours ago")||r==1&&"Yesterday"||r<7&&r+" days ago"||r<31&&Math.ceil(r/7)+" week"+(Math.ceil(r/7)>1?"s":"")+" ago"||r<365&&Math.ceil(r/30)+" months ago"||r>=365&&Math.ceil(r/365)+" year"+(Math.ceil(r/365)>1?"s":"")+" ago"},cache=function(e,t){if(typeof localStorage!==undefined&&typeof JSON!==undefined){var n=(new Date).getTime(),r=null;if(t==undefined){try{r=JSON.parse(unescape(localStorage.getItem(e)))}catch(i){}if(r){if(n-r.time<options.cacheExpire){r=r.data}else{localStorage.removeItem(e);r=null}}else{r=null}return r}else{try{localStorage.setItem(e,escape(JSON.stringify({time:n,data:t})))}catch(i){console.log(i)}}}else{return null}},get=function(){dug.requests=dug.requests==undefined?1:dug.requests+1;var e=document.createElement("script");var t="callback"+dug.requests,n=document.body.children,r=document.scripts[document.scripts.length-1],i=render(options.endpoint),s=r.parentNode.nodeName!="head";dug[t]=function(e,t){e=e.results?e.results:e;if(t!==true){cache(i,e)}var n=document.createElement("div");options.beforeRender.call(this,e);n.innerHTML=render(getTemplate(),e,options.templateDelimiters);if(options.target==null){r.parentNode.insertBefore(n,r);options.target=n}else{if(options.target.nodeName){options.target.innerHTML=n.innerHTML}else if(typeof options.target=="string"){document.getElementById(options.target).innerHTML=n.innerHTML}}options.afterRender.call(this,options.target);options.success.call(this,e)};e.onerror=options.error;if(cachedData=cache(i)){dug[t](cachedData,true)}else{e.src=i+(i.indexOf("?")>-1?"&":"?")+options.callbackParam+"=dug."+t;document.getElementsByTagName("head")[0].appendChild(e)}},init=function(e){if(e&&e!=undefined){if(e.constructor==Object){ext(options,e)}}};for(var o in options){(function(e){this[e]=function(t){if(arguments.length){options[e]=t}else{return options[e]}}}).call(this,o)}this.show=function(e){init(e);get();return this};dug.render=render;dug.extend=ext;dug.cache=cache;dug.ago=ago;init(opts)};dug._script=document.scripts[document.scripts.length-1]